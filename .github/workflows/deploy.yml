name: Deploy to Production

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:  # Permet d√©clenchement manuel

env:
  DOCKER_USERNAME: moustaphafal
  IMAGE_NAME: flask-helloworld

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy with Ansible
      run: |
        ansible-playbook -i ansible/inventory.yml ansible/playbook.yml
      env:
        ANSIBLE_HOST_KEY_CHECKING: 'False'
    
    - name: Verify deployment
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo "üåê Application URL: http://192.168.1.20:5000"
        sleep 3
        curl -f http://192.168.1.20:5000 --max-time 10 || echo "‚ö†Ô∏è Warning: Application may still be starting"
    
    - name: Notify deployment success
      if: success()
      run: |
        echo "================================================"
        echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
        echo "üåê Application is live at: http://192.168.1.20:5000"
        echo "üê≥ Docker image: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "üìÖ Deployed at: $(date)"
        echo "================================================"