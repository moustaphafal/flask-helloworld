name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: moustaphafal
  IMAGE_NAME: flask-helloworld

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Verify merge from develop
      id: verify-merge
      run: |
        echo "================================================"
        echo "üîç VERIFYING DEPLOYMENT PREREQUISITES"
        echo "================================================"
        
        COMMIT_SHA="${{ github.sha }}"
        CURRENT_BRANCH="${{ github.ref_name }}"
        
        echo "üîë Commit SHA: $COMMIT_SHA"
        echo "üìå Current branch: $CURRENT_BRANCH"
        
        # V√©rifier le message du commit
        LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "üìù Last commit message:"
        echo "$LAST_COMMIT_MSG"
        echo ""
        
        # V√©rifier si c'est un merge commit
        PARENT_COUNT=$(git log -1 --pretty=%P | wc -w)
        
        if [ "$PARENT_COUNT" -eq 2 ]; then
          echo "‚úÖ This is a merge commit (has 2 parents)"
          
          # V√©rifier le message
          if echo "$LAST_COMMIT_MSG" | grep -qi "develop"; then
            echo "‚úÖ Commit message mentions 'develop'"
          else
            echo "‚ö†Ô∏è WARNING: Commit message doesn't mention 'develop'"
          fi
          
          # R√©cup√©rer les 2 parents du merge commit
          PARENTS=$(git log -1 --pretty=%P)
          MASTER_PARENT=$(echo $PARENTS | cut -d' ' -f1)
          DEVELOP_PARENT=$(echo $PARENTS | cut -d' ' -f2)
          
          echo "üîç Master parent:  $MASTER_PARENT"
          echo "üîç Develop parent: $DEVELOP_PARENT"
          
          # V√©rifier que le parent develop existe dans la branche develop
          git fetch origin develop 2>/dev/null || {
            echo "‚ùå Cannot fetch develop branch!"
            exit 1
          }
          
          if git merge-base --is-ancestor $DEVELOP_PARENT origin/develop; then
            echo "‚úÖ Develop parent exists in develop branch"
            echo "‚úÖ This merge is from develop"
          else
            echo "‚ùå ERROR: Develop parent NOT found in develop branch!"
            echo "üö´ Deployment cancelled for security"
            exit 1
          fi
          
        elif [ "$PARENT_COUNT" -eq 1 ]; then
          echo "‚ö†Ô∏è This is NOT a merge commit (squash merge or direct push)"
          
          # Pour un squash merge ou direct push, v√©rifier via le message
          if echo "$LAST_COMMIT_MSG" | grep -qiE "(develop|merge.*develop)"; then
            echo "‚úÖ Commit message indicates it comes from develop"
            
            # V√©rification suppl√©mentaire : le commit doit √™tre r√©cent par rapport √† develop
            git fetch origin develop 2>/dev/null || {
              echo "‚ùå Cannot fetch develop branch!"
              exit 1
            }
            
            # V√©rifier que develop a √©t√© mis √† jour r√©cemment (dans les 24h)
            DEVELOP_LAST_COMMIT_DATE=$(git log -1 --format=%ct origin/develop)
            CURRENT_COMMIT_DATE=$(git log -1 --format=%ct HEAD)
            TIME_DIFF=$((CURRENT_COMMIT_DATE - DEVELOP_LAST_COMMIT_DATE))
            
            if [ $TIME_DIFF -lt 86400 ]; then  # 24 heures = 86400 secondes
              echo "‚úÖ Develop branch was updated recently (${TIME_DIFF}s ago)"
              echo "‚úÖ Assuming valid squash merge from develop"
            else
              echo "‚ö†Ô∏è WARNING: Develop branch last updated $((TIME_DIFF / 3600)) hours ago"
              echo "‚ö†Ô∏è This might not be from a recent develop merge"
              
              # Ne pas bloquer, juste avertir
              echo "‚úÖ Proceeding based on commit message"
            fi
          else
            echo "‚ùå ERROR: Commit message doesn't mention 'develop'!"
            echo "‚ùå This appears to be a direct push to $CURRENT_BRANCH"
            echo "üö´ Deployment cancelled for security"
            exit 1
          fi
        else
          echo "‚ùå ERROR: Unexpected number of parents: $PARENT_COUNT"
          exit 1
        fi
        
        echo "================================================"
        echo "‚úÖ ALL SECURITY CHECKS PASSED"
        echo "================================================"
    
    - name: Deploy with Ansible
      run: |
        echo "üöÄ Starting deployment to production..."
        echo "üìÇ Inventory: ansible/inventory.yml"
        echo "üìú Playbook: ansible/playbook.yml"
        ansible-playbook -i ansible/inventory.yml ansible/playbook.yml
      env:
        ANSIBLE_HOST_KEY_CHECKING: 'False'
    
    - name: Verify deployment
      run: |
        echo "‚úÖ Ansible playbook executed successfully!"
        echo "üåê Application URL: http://192.168.1.12:5000"
        echo "‚è≥ Waiting for application to start..."
        sleep 5
        
        # Retry logic avec flag de succ√®s
        SUCCESS=false
        for i in {1..5}; do
          echo "üîÑ Attempt $i/5: Checking application..."
          
          if curl -f http://192.168.1.12:5000 --max-time 10 --silent --output /dev/null; then
            echo "‚úÖ Application is responding!"
            SUCCESS=true
            break
          else
            if [ $i -lt 5 ]; then
              echo "‚è≥ Application not ready yet, waiting 3s..."
              sleep 3
            fi
          fi
        done
        
        if [ "$SUCCESS" = false ]; then
          echo "================================================"
          echo "‚ö†Ô∏è APPLICATION NOT RESPONDING"
          echo "================================================"
          echo "Troubleshooting steps:"
          echo "  1. docker ps"
          echo "  2. docker logs flask-app"
          echo "  3. curl -v http://192.168.1.12:5000"
          echo "================================================"
          exit 1
        fi
    
    - name: Notify deployment success
      if: success()
      run: |
        echo "================================================"
        echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
        echo "================================================"
        echo "üåê Application: http://192.168.1.12:5000"
        echo "üê≥ Docker image: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "üìÖ Deployed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "üë§ Triggered by: ${{ github.actor }}"
        echo "üì¶ Commit: ${{ github.sha }}"
        echo "================================================"
    
    - name: Notify deployment failure
      if: failure()
      run: |
        echo "================================================"
        echo "‚ùå DEPLOYMENT FAILED!"
        echo "================================================"
        echo "Please check the logs above for details"
        echo ""
        echo "Common issues:"
        echo "  ‚Ä¢ Security checks failed (not from develop)"
        echo "  ‚Ä¢ Ansible playbook errors"
        echo "  ‚Ä¢ Application startup errors"
        echo ""
        echo "Check status: docker ps -a"
        echo "Check logs: docker logs flask-app"
        echo "================================================"