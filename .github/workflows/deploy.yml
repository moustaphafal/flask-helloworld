name: Deploy to Production

on:
  push:
    branches: [ main, master ]  # ‚úÖ Se d√©clenche quand PR est merg√©e vers main
  # workflow_dispatch:    # ‚úÖ Permet d√©clenchement manuel

env:
  DOCKER_USERNAME: moustaphafal
  IMAGE_NAME: flask-helloworld

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Verify merge from develop
      id: verify-merge
      run: |
        echo "================================================"
        echo "üîç VERIFYING DEPLOYMENT PREREQUISITES"
        echo "================================================"
        
        # V√©rifier que c'est bien un merge depuis develop
        LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "üìù Last commit: $LAST_COMMIT_MSG"
        
        # V√©rifier si c'est un merge commit
        if git log -1 --merges | grep -q "Merge"; then
          echo "‚úÖ Last commit is a merge commit"
          
          if echo "$LAST_COMMIT_MSG" | grep -qi "develop"; then
            echo "‚úÖ Merged from develop branch"
          else
            echo "‚ö†Ô∏è Merge is NOT from develop"
          fi
        else
          echo "‚ö†Ô∏è Not a merge commit (direct push?)"
        fi
        
        # V√©rifier via API GitHub
        COMMIT_SHA="${{ github.sha }}"
        PR_INFO=$(gh pr list \
          --state merged \
          --base main \
          --json number,headRefName,mergeCommit,labels \
          --jq ".[] | select(.mergeCommit.oid == \"$COMMIT_SHA\")")
        
        if [ -n "$PR_INFO" ]; then
          PR_NUMBER=$(echo $PR_INFO | jq -r '.number')
          PR_BRANCH=$(echo $PR_INFO | jq -r '.headRefName')
          PR_LABELS=$(echo $PR_INFO | jq -r '.labels[].name')
          
          echo "‚úÖ Merged from PR #$PR_NUMBER (branch: $PR_BRANCH)"
          echo "üìã Labels: $PR_LABELS"
          
          if [ "$PR_BRANCH" != "develop" ]; then
            echo "‚ùå ERROR: PR was from '$PR_BRANCH', not 'develop'!"
            echo "üö´ Deployment cancelled for security reasons"
            exit 1
          fi
          
          if ! echo "$PR_LABELS" | grep -q "ci-passed"; then
            echo "‚ö†Ô∏è WARNING: PR does not have 'ci-passed' label"
          fi
        else
          echo "‚ö†Ô∏è No PR metadata found"
          
          # V√©rifier que le commit existe dans develop
          git fetch origin develop
          if git merge-base --is-ancestor $COMMIT_SHA origin/develop; then
            echo "‚úÖ Commit exists in develop"
          else
            echo "‚ùå ERROR: Commit NOT from develop!"
            echo "üö´ Deployment cancelled"
            exit 1
          fi
        fi
        
        echo "================================================"
        echo "‚úÖ ALL CHECKS PASSED"
        echo "================================================"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Deploy with Ansible
      run: |
        echo "üöÄ Starting deployment to production..."
        ansible-playbook -i ansible/inventory.yml ansible/playbook.yml
      env:
        ANSIBLE_HOST_KEY_CHECKING: 'False'
    
    - name: Verify deployment
      run: |
        echo "‚úÖ Ansible playbook executed successfully!"
        echo "üåê Application URL: http://192.168.1.20:5000"
        echo "‚è≥ Waiting for application to start..."
        sleep 5
        
        # Retry logic avec timeout
        for i in {1..5}; do
          if curl -f http://192.168.1.20:5000 --max-time 10 --silent --output /dev/null; then
            echo "‚úÖ Application is responding!"
            exit 0
          else
            echo "‚è≥ Attempt $i/5: Waiting for application..."
            sleep 3
          fi
        done
        
        echo "‚ö†Ô∏è Application did not respond after 5 attempts"
        echo "Check application logs with: docker logs flask-app"
        exit 1
    
    - name: Notify deployment success
      if: success()
      run: |
        echo "================================================"
        echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
        echo "================================================"
        echo "üåê Application: http://192.168.1.20:5000"
        echo "üê≥ Docker image: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "üìÖ Deployed at: $(date)"
        echo "üë§ Triggered by: ${{ github.actor }}"
        echo "================================================"
    
    - name: Notify deployment failure
      if: failure()
      run: |
        echo "================================================"
        echo "‚ùå DEPLOYMENT FAILED!"
        echo "================================================"
        echo "Please check the logs above for details"
        echo "You can also check application logs:"
        echo "  docker logs flask-app"
        echo "================================================"